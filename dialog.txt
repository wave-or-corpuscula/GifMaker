# Контекст для продолжения работы с ffmpeg-next

## Цель проекта
Переписать bash скрипт для создания видео с переходами и наложением текста на Rust с использованием ffmpeg-next для кроссплатформенности.

## Оригинальный bash функционал (raw_scripts.sh):
1. Создание фонового видео с переходом между красным и синим цветами:
   ffmpeg -y -filter_complex "color=c=red:d=6s [red]; color=c=blue:d=6s [blue]; [red][blue]xfade=transition=vertclose:duration=6s" test/background.mp4

2. Наложение текста с поддержкой переносов строк и плавного появления:
   ffmpeg -y -i test/background.mp4 -vf "drawtext=textfile=/tmp/first_text.txt:reload=1:line_spacing=-10:x=(w-text_w)/2:y=(h-text_h)/2:fontsize=20:fontcolor=blue, drawtext=textfile=/tmp/second_text.txt:x=(w-text_w)/2:y=(h-text_h)/2:fontsize=20:fontcolor=red:alpha='if(gte(t,2),if(lte(t,4),(t-2)/2,1),0)'" -c:a copy test/output.mp4

## Текущий статус (src/main.rs):
✅ Базовая структура работает:
- Инициализация FFmpeg
- Создание выходного файла
- Поиск и настройка кодека H264
- Создание видеопотока с правильными параметрами
- Запись заголовка и трейлера

## Ключевые открытия и решения проблем:
1. **Проблема с "codec none"**: Нужно правильно настраивать кодировщик перед добавлением потока
2. **Правильный подход из transcode-x264.rs примера**:
   ```rust
   let codec = encoder::find(codec::Id::H264);
   let mut stream = octx.add_stream(codec)?;
   let mut encoder = codec::context::Context::new_with_codec(codec)
       .encoder()
       .video()?;
   encoder.set_width(1280);
   encoder.set_height(720);
   encoder.set_format(ffmpeg::format::Pixel::YUV420P);
   encoder.set_time_base(ffmpeg::Rational(1, 25));
   encoder.set_frame_rate(Some(ffmpeg::Rational(25, 1)));
   let opened_encoder = encoder.open_with(ffmpeg::Dictionary::new())?;
   stream.set_parameters(&opened_encoder);
   ```

## Следующие шаги:
1. **Добавить генерацию кадров**: Создать frame, заполнить его данными, отправить в кодировщик
2. **Реализовать заполнение кадров цветом**: Создать красные и синие кадры
3. **Реализовать переход xfade**: Использовать фильтры ffmpeg-next для перехода между цветами
4. **Добавить наложение текста**: Реализовать drawtext функциональность

## Важные методы и API:
- `ffmpeg::format::output(path)` - создать выходной файл
- `encoder::find(codec::Id::H264)` - найти кодек
- `output.add_stream(codec)` - добавить поток
- `codec::context::Context::new_with_codec(codec)` - создать контекст кодировщика
- `encoder.open_with(Dictionary)` - открыть кодировщик
- `stream.set_parameters(&encoder)` - установить параметры в поток
- `output.write_header()` - записать заголовок
- `output.write_trailer()` - записать трейлер

## Зависимости (Cargo.toml):
```toml
[dependencies]
ffmpeg-next = "8.0.0"
```

## Команды для работы:
- `cargo check` - проверить код на ошибки
- `cargo run` - запустить программу
- `cargo build` - собрать проект

## Файлы:
- `src/main.rs` - основной код
- `Cargo.toml` - зависимости проекта
- `raw_scripts.sh` - оригинальный bash скрипт для справки
- `test/output.mp4` - выходной файл (создается программой)

## Системные требования:
- FFmpeg с поддержкой libx264 (для кроссплатформенности)
- Rust (edition 2024)
- libavcodec, libavformat, libavutil